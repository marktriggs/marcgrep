<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>

  <head>
    <link type="text/css" href="css/flick/jquery-ui-1.8.16.custom.css" rel="Stylesheet" />	
    <link rel="stylesheet" type="text/css" href="css/reset.css" />
    <link rel="stylesheet" type="text/css" href="css/styles.css" />

    <script src="js/jquery-1.6.2.min.js"></script>
    <script src="js/jquery-ui-1.8.16.custom.min.js"></script>
    <script src="js/json2.js"></script>
    <script src="js/marcgrep.js"></script>
  </head>

  <body>
    <img class="logo" src="logo.png" />

    <p>This is a tool for extracting all of the MARC records that match
      some given criteria.</p>
    <p>To get started, define the criteria of interest below and
      submit your job to the system.</p>

    <select class="boolean_options" style="display: none">
      <option value="AND">AND</option>
      <option value="OR">OR</option>
    </select>

    <div class="container">
      <h2><img class="step" src="1.png" /> Add jobs to the system</h2>

      <div class="button_container">
        <input id="remove_button"class="remove_button" type="button" value="remove"/>
        <input id="group_button"class="group_button" type="button" value="group"/>
        <input id="ungroup_button"class="ungroup_button" type="button" value="ungroup"/>
      </div>

      <h3>Define your query...</h3>
      <div class="define_query">
        <div class="choose_source">
          <span class="label source_label">Find all the records in</span>
          <div class="source_options source_options_style">
          </div>

        </div>

        <div class="clause_group clause_group_style">
          <div class="where_clause">
            <span class="label boolean_label">Where</span>
            <div class="clause">
              <span>the</span>
              <span class="target_field_container"></span>
              <span>field</span>
              <select class="operator">
                <option value="contains">exists and contains</option>
                <option value="does_not_contain">exists and doesn't contain</option>
                <option value="equals">exists and is exactly</option>
                <option value="not_equals">exists and isn't</option>
                <option no_value=1 value="exists">exists</option>
                <option no_value=1 value="does_not_exist">doesn't exist</option>
                <option value="matches_regexp">matches regular expression</option>
                <option value="does_not_match_regexp">doesn't match regular expression</option>
                <option no_wildcard_field=1 no_value=1 value="repeats_field">appears more than once</option>
                <option no_wildcard_field=1 no_value=1 value="does_not_repeat_field">appears exactly once</option>
              </select>
              <span><input type="text" class="field_value" /></span>
            </div>
          </div>
        </div>

        <script type="text/javascript">
          text_input($('.target_field_container'), 'target_field',
          'target_field', '', 'e.g. 245, 245$a, 245!01$a<br>or * for "any field"');
        </script>

        <div class="and_or_buttons">
          <input type="button" id="preview_query" value="Preview query" style="display: none"/>
          <input type="button" class="and_button" value="AND"/>
          <input type="button" class="or_button" value="OR"/>
        </div>


        <div class="querysection" style="display: none">
          <h2>Your Query</h2>
          <div id="querydisplay">&nbsp;</div>
        </div>
      </div>


      <div class="choose_output">
        <h3>Choose an output option...</h3>
        <div class="output_options">
        </div>
      </div>

      <div id="submit_button" class="submit_button">
        <h3>Submit your job</h3>
        <input id="submit" type="button" value="Submit job"/>
      </div>
    </div>

    <div class="joblist" style="display: none">
      <h2>
        <img class="step" src="2.png" /> Run your job(s)
      </h2>

      <div class="job_control">
        <input type="button" class="bombs_away" value="Run all jobs"/>
      </div>


      <table id="job_list">
        <tr>
          <th>Query</th>
          <th>Submitted at</th>
          <th>Status</th>
          <th>&nbsp;</th>
          <th>&nbsp;</th>
        </tr>
      </table>
    </div>


    <script>
      <!-- Wire up the buttons -->
      $('#preview_query').click(function (elt) {
          $('.querysection').dialog({width : 650, height: 650});
      });


      $('.and_button').click(function (elt) {
          add_clause(elt, "AND");
      });

      $('.or_button').click(function (elt) {
          add_clause(elt, "OR");
      });

      $('#group_button').click(function (elt) {
          merge_groups();
      });

      $('#ungroup_button').click(function (elt) {
          split_groups();
      });

      $('#remove_button').click(function (elt) {
          remove_groups();
      });


      $(':button').click(function (elt) { update_form(); });
      $('input').change(function (elt) { update_form(); });
      $('select').change(function (elt) { update_form(); });

      $('#submit').click(function (elt) {
          var query = generate_query();
          $.ajax({
              "type" : "POST",
              "url" : "add_job",
              "data" : {"query" : query,
                        "field-options" : extract_output_options(),
                        "source" : $('#selected_source').val(),
                        "destination" : $('#selected_output').val()},
              "success" : function() {
                  get_job_list();
              }
          });
      });


      $('.bombs_away').click(function (elt) {
          run_jobs();
      });


      update_form();

      setInterval(function() { get_job_list(); }, 2000);
      get_job_list();
      get_source_options();
      get_output_options();
    </script>


  </body>
</html>
